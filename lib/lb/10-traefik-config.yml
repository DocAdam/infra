# TODO(adam): notes from docs
# - store certs in kv? (Why not k8s Secret?)
#   - https://docs.traefik.io/configuration/acme/#as-a-key-value-store-entry
# - https://docs.traefik.io/configuration/commons/#custom-error-pages
apiVersion: v1
kind: ConfigMap
metadata:
  name: traefik-config
  namespace: lb
data:
  traefik.yaml: |
    global:
      checkNewVersion: true
      sendAnonymousUsage: true
    entryPoints:
      http:
        address: ":80"
      https:
        address: ":443"
        forwardedHeaders:
          trustedIPs:
            - "10.0.0.0/8"
      traefik:
        address: ":8081"
    providers:
      providersThrottleDuration: 2s
      file:
        filename: "/etc/traefik/traefik.yaml"
        watch: true
      # kubernetesIngress:
      #   namespaces: [apps, infra, lb]
    http:
      services:
        api:
          loadBalancer:
            servers:
              - url: 'http://api.apps.svc.cluster.local:8080/'
            healthCheck:
              path: "/"
              interval: "30s"
              timeout: "5s"
              scheme: http
        api-apps:
          loadBalancer:
            servers:
              - url: 'http://api-apps.apps.svc.cluster.local:8080/'
            healthCheck:
              path: "/"
              interval: "30s"
              timeout: "5s"
              scheme: http
        docs:
          loadBalancer:
            servers:
              - url: 'http://docs.apps.svc.cluster.local:8080/'
            healthCheck:
              path: "/"
              interval: "30s"
              timeout: "5s"
              scheme: http
        moovio:
          loadBalancer:
            servers:
              - url: 'http://moovio.apps.svc.cluster.local:8080/'
            healthCheck:
              path: "/"
              interval: "30s"
              timeout: "5s"
              scheme: http
        ach:
          loadBalancer:
            servers:
              - url: 'http://ach.apps.svc.cluster.local:8080/'
            healthCheck:
              path: "/ping"
              interval: "30s"
              timeout: "5s"
              scheme: http
        auth:
          loadBalancer:
            servers:
              - url: 'http://auth.apps.svc.cluster.local:8080/'
            healthCheck:
              path: "/ping"
              interval: "30s"
              timeout: "5s"
              scheme: http
        paygate:
          loadBalancer:
            servers:
              - url: 'http://paygate.apps.svc.cluster.local:8080/'
            healthCheck:
              path: "/ping"
              interval: "30s"
              timeout: "5s"
              scheme: http
        slackin:
          loadBalancer:
            servers:
              - url: 'http://slackin.sales.svc.cluster.local:3000/'
            healthCheck:
              path: "/"
              interval: "30s"
              timeout: "5s"
              scheme: http
        watchman:
          loadBalancer:
            servers:
              - url: 'http://watchman.apps.svc.cluster.local:8080/'
            healthCheck:
              path: "/ping"
              interval: "30s"
              timeout: "5s"
              scheme: http
        accounts:
          loadBalancer:
            servers:
              - url: 'http://accounts.apps.svc.cluster.local:8080/'
            healthCheck:
              path: "/ping"
              interval: "30s"
              timeout: "5s"
              scheme: http
        fed:
          loadBalancer:
            servers:
              - url: 'http://fed.apps.svc.cluster.local:8080/'
            healthCheck:
              path: "/ping"
              interval: "30s"
              timeout: "5s"
              scheme: http
        customers:
          loadBalancer:
            servers:
              - url: 'http://customers.apps.svc.cluster.local:8080/'
            healthCheck:
              path: "/ping"
              interval: "30s"
              timeout: "5s"
              scheme: http
        imagecashletter:
          loadBalancer:
            servers:
              - url: 'http://imagecashletter.apps.svc.cluster.local:8080/'
            healthCheck:
              path: "/ping"
              interval: "30s"
              timeout: "5s"
              scheme: http
        oauth2-proxy:
          loadBalancer:
            servers:
              - url: 'http://oauth2-proxy.infra.svc.cluster.local:4180/'
        soc2:
          loadBalancer:
            servers:
              - url: 'http://soc2.apps.svc.cluster.local:8080/'
            healthCheck:
              path: "/"
              interval: "30s"
              timeout: "5s"
              scheme: http
        corteza:
          loadBalancer:
            servers:
              - url: "http://corteza-webapp.sales.svc.cluster.local/"
            healthCheck:
              path: "/"
              interval: "10s"
              timeout: "5s"
              scheme: http
        corteza-api:
          loadBalancer:
            servers:
              - url: "http://corteza-server.sales.svc.cluster.local/"
            healthCheck:
              path: "/version"
              interval: "10s"
              timeout: "5s"
              scheme: http
      middlewares:
        auth-clean:
          headers:
            customRequestHeaders:
              X-User-Id: "" # Removes
        auth-check:
          forwardAuth:
            # address: https://api.moov.io/v1/auth/check
            address: http://auth.apps.svc.cluster.local:8080/auth/check
            authResponseHeaders:
              - Content-Type
              - X-User-Id
        cors:
          headers:
            accessControlAllowCredentials: true
            accessControlAllowMethods: [GET, OPTIONS, PUT, POST, DELETE]
            accessControlAllowOrigin: "*"
            accessControlMaxAge: 600
        remote-addr:
          headers:
            hostsProxyHeaders:
              - X-Forwarded-For
        api-moov-io-http:
          redirectScheme:
            scheme: https
            permanent: true
        crm-moov-io-http:
          redirectScheme:
            scheme: https
            permanent: true
        docs-moov-io-http:
          redirectScheme:
            scheme: https
            permanent: true
        infra-moov-io-http:
          redirectScheme:
            scheme: https
            permanent: true
        slack-moovio-http:
          redirectScheme:
            scheme: https
            permanent: true
        moov-io-http:
          redirectScheme:
            scheme: https
            permanent: true
        ach:
          stripPrefix:
            prefixes:
              - "/v1/ach/"
        auth:
          stripPrefix:
            prefixes:
              - "/v1/"
        auth-ping:
          stripPrefix:
            prefixes:
              - "/v1/auth"
        paygate-depositories:
          stripPrefix:
            prefixes:
              - "/v1/ach/"
        paygate-events:
          stripPrefix:
            prefixes:
              - "/v1/ach/"
        paygate-gateways:
          stripPrefix:
            prefixes:
              - "/v1/ach/"
        paygate-originators:
          stripPrefix:
            prefixes:
              - "/v1/ach/"
        paygate-receivers:
          stripPrefix:
            prefixes:
              - "/v1/ach/"
        paygate-transfers:
          stripPrefix:
            prefixes:
              - "/v1/ach/"
        paygate-ping:
          stripPrefix:
            prefixes:
              - "/v1/paygate"
        moovio-watchman:
          stripPrefix:
            prefixes:
              - "/watchman"
        watchman:
          stripPrefix:
            prefixes:
              - "/v1/watchman"
        accounts:
          stripPrefix:
            prefixes:
              - "/v1/"
        accounts-ping:
          stripPrefix:
            prefixes:
              - "/v1/accounts"
        fed:
          stripPrefix:
            prefixes:
              - "/v1/"
        fed-ping:
          stripPrefix:
            prefixes:
              - "/v1/fed/"
        customers:
          stripPrefix:
            prefixes:
              - "/v1/"
        imagecashletter:
          stripPrefix:
            prefixes:
              - "/v1/imagecashletter"
        soc2:
          stripPrefix:
            prefixes:
              - "/soc2"
      routers:
        ach-ping:
          entryPoints: [https]
          service: ach
          rule: "Host(`api.moov.io`) && Path(`/v1/ach/ping`)"
          middlewares:
            - ach
            - cors
          tls:
            certResolver: default
            domains:
              - main: "api.moov.io"
        ach:
          entryPoints: [https]
          service: ach
          rule: "Host(`api.moov.io`) && PathPrefix(`/v1/ach/files`)"
          middlewares:
            - auth-clean
            - auth-check
            - ach
            - cors
          tls:
            certResolver: default
            domains:
              - main: "api.moov.io"
        auth-ping:
          entryPoints: [https]
          service: auth
          rule: "Host(`api.moov.io`) && PathPrefix(`/v1/auth/ping`)"
          middlewares:
            - auth-ping
            - cors
          tls:
            certResolver: default
            domains:
              - main: "api.moov.io"
        auth-check:
          entryPoints: [https]
          service: auth
          rule: "Host(`api.moov.io`) && Path(`/v1/auth/check`, `/v1/users/check`, `/v1/oauth2/token`)"
          middlewares:
            - auth
            - cors
          tls:
            certResolver: default
            domains:
              - main: "api.moov.io"
        auth:
          entryPoints: [https]
          service: auth
          rule: "Host(`api.moov.io`) && PathPrefix(`/v1/users/`, `/v1/oauth2/`)"
          middlewares:
            - auth-clean
            - auth
            - cors
          tls:
            certResolver: default
            domains:
              - main: "api.moov.io"
        "paygate-depositories":
          entryPoints: [https]
          service: paygate
          rule: "Host(`api.moov.io`) && PathPrefix(`/v1/ach/depositories`)"
          middlewares:
            - auth-clean
            - auth-check
            - cors
            - paygate-depositories
          tls:
            certResolver: default
            domains:
              - main: "api.moov.io"
        "paygate-events":
          entryPoints: [https]
          service: paygate
          rule: "Host(`api.moov.io`) && PathPrefix(`/v1/ach/events`)"
          middlewares:
            - auth-clean
            - auth-check
            - cors
            - paygate-events
          tls:
            certResolver: default
            domains:
              - main: "api.moov.io"
        "paygate-gateways":
          entryPoints: [https]
          service: paygate
          rule: "Host(`api.moov.io`) && PathPrefix(`/v1/ach/gateways`)"
          middlewares:
            - auth-clean
            - auth-check
            - cors
            - paygate-gateways
          tls:
            certResolver: default
            domains:
              - main: "api.moov.io"
        "paygate-originators":
          entryPoints: [https]
          service: paygate
          rule: "Host(`api.moov.io`) && PathPrefix(`/v1/ach/originators`)"
          middlewares:
            - auth-clean
            - auth-check
            - cors
            - paygate-originators
          tls:
            certResolver: default
            domains:
              - main: "api.moov.io"
        "paygate-receivers":
          entryPoints: [https]
          service: paygate
          rule: "Host(`api.moov.io`) && PathPrefix(`/v1/ach/receivers`)"
          middlewares:
            - auth-clean
            - auth-check
            - cors
            - paygate-receivers
          tls:
            certResolver: default
            domains:
              - main: "api.moov.io"
        "paygate-transfers":
          entryPoints: [https]
          service: paygate
          rule: "Host(`api.moov.io`) && PathPrefix(`/v1/ach/transfers`)"
          middlewares:
            - auth-clean
            - auth-check
            - cors
            - paygate-transfers
            - remote-addr
          tls:
            certResolver: default
            domains:
              - main: "api.moov.io"
        "paygate-ping":
          entryPoints: [https]
          service: paygate
          rule: "Host(`api.moov.io`) && PathPrefix(`/v1/paygate/ping`)"
          middlewares:
            - cors
            - paygate-ping
          tls:
            certResolver: default
            domains:
              - main: "api.moov.io"
        "watchman-ping":
          entryPoints: [https]
          service: watchman
          rule: "Host(`api.moov.io`) && PathPrefix(`/v1/watchman/ping`)"
          middlewares:
            - cors
            - watchman
          tls:
            certResolver: default
            domains:
              - main: "api.moov.io"
        "watchman":
          entryPoints: [https]
          service: watchman
          rule: "Host(`api.moov.io`) && PathPrefix(`/v1/watchman/`)"
          middlewares:
            - auth-clean
            - auth-check
            - cors
            - watchman
          tls:
            certResolver: default
            domains:
              - main: "api.moov.io"
        "accounts":
          entryPoints: [https]
          service: accounts
          rule: "Host(`api.moov.io`) && PathPrefix(`/v1/accounts`)"
          middlewares:
            - auth-clean
            - auth-check
            - accounts
            - cors
          tls:
            certResolver: default
            domains:
              - main: "api.moov.io"
        "accounts-ping":
          entryPoints: [https]
          service: accounts
          rule: "Host(`api.moov.io`) && PathPrefix(`/v1/accounts/ping`)"
          middlewares:
            - accounts-ping
            - cors
          tls:
            certResolver: default
            domains:
              - main: "api.moov.io"
        "fed":
          entryPoints: [https]
          service: fed
          rule: "Host(`api.moov.io`) && (PathPrefix(`/v1/fed/ach`) || PathPrefix(`/v1/fed/wire`))"
          middlewares:
            - auth-clean
            - auth-check
            - cors
            - fed
          tls:
            certResolver: default
            domains:
              - main: "api.moov.io"
        "fed-ping":
          entryPoints: [https]
          service: fed
          rule: "Host(`api.moov.io`) && PathPrefix(`/v1/fed/ping`)"
          middlewares:
            - cors
            - fed-ping
          tls:
            certResolver: default
            domains:
              - main: "api.moov.io"
        "customers":
          entryPoints: [https]
          service: customers
          rule: "Host(`api.moov.io`) && PathPrefix(`/v1/customers/`)"
          middlewares:
            - auth-clean
            - auth-check
            - cors
            - customers
          tls:
            certResolver: default
            domains:
              - main: "api.moov.io"
        "imagecashletter":
          entryPoints: [https]
          service: imagecashletter
          rule: "Host(`api.moov.io`) && PathPrefix(`/v1/imagecashletter/`)"
          middlewares:
            - auth-clean
            - auth-check
            - cors
            - imagecashletter
          tls:
            certResolver: default
            domains:
              - main: "api.moov.io"
        "api-moov-io-http":
          entryPoints: [http]
          service: api
          rule: "Host(`api.moov.io`)"
          middlewares:
            - api-moov-io-http
            - cors
        "api-moov-io":
          entryPoints: [https]
          service: api
          rule: "Host(`api.moov.io`) && (Path(`/`, `/style.css`, `/rapidoc-min.js`, `/scroll.js`, `/v1/`) || PathPrefix(`/apps/`, `/admin/`))"
          middlewares:
            - cors
          tls:
            certResolver: default
            domains:
              - main: "api.moov.io"
        "docs-moov-io-http":
          entryPoints: [http]
          service: docs
          rule: "Host(`docs.moov.io`)"
          middlewares:
            - docs-moov-io-http
        "docs-moov-io":
          entryPoints: [https]
          service: docs
          rule: "Host(`docs.moov.io`)"
          tls:
            certResolver: default
            domains:
              - main: "docs.moov.io"
        "slack-moovio":
          entryPoints: [https]
          service: slackin
          rule: "Host(`slack.moov.io`)"
          tls:
            certResolver: default
            domains:
              - main: "slack.moov.io"
        "slack-moovio-http":
          entryPoints: [http]
          service: slackin
          rule: "Host(`slack.moov.io`)"
          middlewares:
            - slack-moovio-http
        "moovio-watchman":
          entryPoints: [https]
          service: watchman
          rule: "Host(`moov.io`) && PathPrefix(`/watchman`)"
          middlewares:
            - moovio-watchman
          tls:
            certResolver: default
            domains:
              - main: "moov.io"
        "moov-io-http":
          entryPoints: [http]
          service: moovio
          rule: "Host(`moov.io`)"
          middlewares:
            - moov-io-http
        "moov-io":
          entryPoints: [https]
          service: moovio
          rule: "Host(`moov.io`)"
          tls:
            certResolver: default
            domains:
              - main: "moov.io"
        "infra-oauth2":
          entryPoints: [https]
          service: oauth2-proxy
          rule: "Host(`infra.moov.io`) && PathPrefix(`/oauth2`)"
          tls:
            certResolver: default
            domains:
              - main: "infra.moov.io"
        "infra-moov-io-http":
          entryPoints: [http]
          service: oauth2-proxy
          rule: "Host(`infra.moov.io`)"
          middlewares:
            - infra-moov-io-http
        "infra-idx":
          entryPoints: [https]
          service: oauth2-proxy
          rule: "Host(`infra.moov.io`) && Path(`/`)"
          tls:
            certResolver: default
            domains:
              - main: "infra.moov.io"
        alertmanager:
          entryPoints: [https]
          service: oauth2-proxy
          rule: "Host(`infra.moov.io`) && PathPrefix(`/alertmanager/`)"
          tls:
            certResolver: default
            domains:
              - main: "infra.moov.io"
        traefik:
          entryPoints: [https]
          service: oauth2-proxy
          rule: "Host(`infra.moov.io`) && PathPrefix(`/traefik/`)"
          tls:
            certResolver: default
            domains:
              - main: "infra.moov.io"
        prometheus:
          entryPoints: [https]
          service: oauth2-proxy
          rule: "Host(`infra.moov.io`) && PathPrefix(`/prometheus/`)"
          tls:
            certResolver: default
            domains:
              - main: "infra.moov.io"
        grafana:
          entryPoints: [https]
          service: oauth2-proxy
          rule: "Host(`infra.moov.io`) && PathPrefix(`/grafana/`)"
          tls:
            certResolver: default
            domains:
              - main: "infra.moov.io"
        polaris:
          entryPoints: [https]
          service: oauth2-proxy
          rule: "Host(`infra.moov.io`) && PathPrefix(`/polaris/`)"
          tls:
            certResolver: default
            domains:
              - main: "infra.moov.io"
        stargazers:
          entryPoints: [https]
          service: oauth2-proxy
          rule: "Host(`crm.moov.io`) && PathPrefix(`/stargazers`)"
          tls:
            certResolver: default
            domains:
              - main: "crm.moov.io"
        corteza:
          entryPoints: [https]
          service: corteza
          rule: "Host(`crm.moov.io`)"
          tls:
            certResolver: default
            domains:
              - main: "crm.moov.io"
        "crm-moov-io-http":
          entryPoints: [http]
          service: oauth2-proxy
          rule: "Host(`crm.moov.io`)"
          middlewares:
            - crm-moov-io-http
        corteza-api:
          entryPoints: [https]
          service: corteza-api
          rule: "Host(`api.crm.moov.io`)"
          tls:
            certResolver: default
            domains:
              - main: "api.crm.moov.io"
        soc2:
          entryPoints: [https]
          service: soc2
          rule: "Host(`moov.io`) && PathPrefix(`/soc2`)"
          middlewares:
            - soc2
          tls:
            certResolver: default
            domains:
              - main: "moov.io"
    api:
      insecure: true
      dashboard: true
    metrics:
      prometheus: {}
    ping:
      entryPoint: https
    log:
      level: INFO
    accessLog: {}
    certificatesResolvers:
      default:
        acme:
          email: security@moov.io
          caServer: "https://acme-v02.api.letsencrypt.org/directory"
          storage: /opt/traefik/letsencrypt.json
          keyType: EC384
          httpChallenge:
            entryPoint: http
  nginx.conf: |
    daemon off;
    worker_processes  1;
    error_log  /var/log/nginx/error.log warn;
    # error_log /dev/stdout warn;
    pid       /var/run/nginx.pid;
    events {
      worker_connections  1024;
    }
    http {
      include       /etc/nginx/mime.types;
      default_type  application/octet-stream;
      log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
      '$status $body_bytes_sent "$http_referer" '
      '"$http_user_agent" "$http_x_forwarded_for"';

      access_log  /var/log/nginx/access.log  main;
      # access_log /dev/stdout main;
      sendfile        on;
      #tcp_nopush     on;
      keepalive_timeout 65;
      gzip  on;
      include /opt/nginx/conf.d/*.conf;
    }
  default.conf: |
    server {
      listen 8080;
      root /usr/share/nginx/www;
      index index.html index.htm;
      stub_status;
      location /traefik/ {
        rewrite    /traefik/(.*) /$1 break;
        proxy_pass http://localhost:8081/;
      }
    }
  # metrics is for prometheus metrics scraping
  # (avoid error logs)
  metrics: |
    # no content
  index.html: |
    nginx - traefik
---
